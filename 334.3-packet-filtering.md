# 334.3 Packet Filtering

**Weight:** 5

**Description:** Candidates should be familiar with the use and configuration of the netfilter Linux packet filter.



**Key Knowledge Areas:**

* Understand common firewall architectures, including DMZ
* Understand and use iptables and ip6tables, including standard modules, tests and targets
* Implement packet filtering for IPv4 and IPv6
* Implement connection tracking and network address translation
* Manage IP sets and use them in netfilter rules
* Awareness of nftables and nft
* Awareness of ebtables
* Awareness of conntrackd

**Partial list of the used files, terms and utilities:**

* iptables
* ip6tables
* iptables-save
* iptables-restore
* ip6tables-save
* ip6tables-restore
* ipset

## Firewall Review

Lets review what we have learned from LPIC-2:

### netfilter

Like any other modern operating system, linux has firewall. First lets see how linux firewalling is organized:

<figure><img src=".gitbook/assets/route-netfilter.jpg" alt=""><figcaption></figcaption></figure>

There is a firewalling functionality which is implemented in linux kernel with netfilter. netfilter is a kernel module and any network traffic which kernel forward to any interface(s), is pass through netfilter. This way netfilter can make decision whether incomming or out going traffic is allowed or not. The major interface to the netfilter module is iptables. iptables has been around for a long time and it let us to do any advanced configuration on linux firewalls.

While being able to do any advanced firewall configuration is count as iptables advantage, the biggest disadvantage of iptables is its complexity. This disadvantage has been caused other solutions have been invented like ufw , firewalld . They both work with iptables behind the sence and make firewall configuration easier for us.

### iptables

iptables works with tables! There are at present three tables:

* **Filter :** The filter table is used for packet filtering.
* **NAT :** The nat table is used for address translation.
* **Mangle :** The mangle table can be used for special-purpose processing of packets.

Within tables there are chains. Chains are used to define what kind of packet follow should be filtered exactly.

<figure><img src=".gitbook/assets/route-iptables.jpg" alt=""><figcaption></figcaption></figure>

* **PREROUTING:** configured to block, redirect or allow the packet to the next chain. Commonly, used to redirect the packet to another address or/and port. (DNAT-Destination NAT).  If destination is local ( this machine) sent to INPUT chain. If bound for another network, sent to the FORWARD chain.
* INPUT: Configured to be blocked, logged or sent to the local system to be handled by the appropriate client, application or service.
* OUTPUT:  packet is sent from the firewall out to the network to its final destination.(Rules usually are not applied at this chain)
* FORWARD : Configured to block, logged or sent to the POSTROUTING chain.
* **POSTROUTING:**  make changes to the packet as it exits the firewall, commonly used to do masquerading.&#x20;

How tables and chain are related so ? All three tree tables (FILTER, NAT, MANGLE) can be present in chains(filter points) but not every chain has all three table represented:

<figure><img src=".gitbook/assets/route-iptables-tchains.jpg" alt=""><figcaption></figcaption></figure>

* **PREROUTING ( **_**NAT**_** ,** MANGLE**)**
* INPUT (**FILTER** , MANGLE )
* FORWARD (**FILTER** , MANGLE )
* OUTPUT (**FILTER** ,  _**NAT**_ , MANGLE)
* **POSTROUTING (**_**NAT**_** ,** MANGLE**)**

How rules are broken down within the firewall system? chains are filtering points that we can create rules, and rules are apllied to the packet passing trough. The rules define what exactly should happen to a packet.

When packets are filterd trough the iptables firewall it will go tough the rules one by one, and the idea is "exit on match". So if a packet matches specific rule , the rule will be applied and nothing else will be applied in that chain any more. So ordering in iptables is very important.

In every rule there us target, The typical target is ACCEPT:

* **ACCEPT** : the package is allowed
* **DROP** : The package is not allowed, the package will be sileintly dropped and the sender of package doesn't know anything.
* **REJECT** :  Do not allow package, the sender of package will get an ICMP warnnig message.
* **LOG :** just LOGs
* **MASQUARATE :** used for NAT.

the target indicated with -j option. we will talk about that.

In every chain there is a policy. The policy define the default behaviour. The default policy is ACCEPT but its isa good practice to have a policy that will drop every thing that doesn't match specific packet in a chain. to set chain default policy

### iptables commands





Advanced Firewall Concepts



Nftables
