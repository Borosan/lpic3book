# 331.3 Encrypted File Systems

**Weight:** 3

**Description:** Candidates should be able to set up and configure encrypted file systems.



**Key Knowledge Areas:**

* Understand block device and file system encryption
* Use dm-crypt with LUKS1 to encrypt block devices
* Use eCryptfs to encrypt file systems, including home directories and PAM integration
* Awareness of plain dm-crypt
* Awareness of LUKS2 features
* Conceptual understanding of Clevis for LUKS devices and Clevis PINs for TMP2 and Network Bound Disk Encryption (NBDE)/Tang

**The following is a partial list of the used files, terms and utilities:**

* cryptsetup (including relevant subcommands)
* cryptmount
* /etc/crypttab
* ecryptfsd
* ecryptfs-\* commands
* mount.ecryptfs, umount.ecryptfs
* pam\_ecryptfs

## Disk Encryption Concepts

Data encryption at rest is a must-have for any modern company. Many companies, however, don't encrypt their disks, because they fear the potential performance penalty caused by encryption overhead.

Protecting Removable medias and adding additional data security are some use cases of disk encryption.

### Methods of disk Encryption

* **Block Device**
* **File System Level**

Whole disk encryption protects a disk in the event of theft or accidental loss. Whole disk encryption encrypts the entire disk including swap files, system files, and hibernation files. If an encrypted disk is lost, stolen, or placed into another computer, the encrypted state of the drive remains unchanged, and only an authorized user can access its contents. Whole disk encryption cannot protect you when you have logged into the system during startup and then leave your computer unattended. Unauthorized users could open any file on the disk. This is where file encryption comes in.

### Disk Encryption Tools

* **dm-encrypt** and LUKS (Two different tools, usually goes hand-in-hand)
* **cryptmount** (useful for end-user to encrypt data)
* **eCryptfs** (file system level encryption)
* **EncFS** (Like eCryptfs but more user friendly)

<figure><img src=".gitbook/assets/diskencryption-tools.jpg" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
**Whole Disk Encryption versus File Encryption**

Whole disk encryption protects a disk in the event of theft or accidental loss. Whole disk encryption encrypts the entire disk including swap files, system files, and hibernation files. If an encrypted disk is lost, stolen, or placed into another computer, the encrypted state of the drive remains unchanged, and only an authorized user can access its contents. Whole disk encryption cannot protect you when you have logged into the system during startup and then leave your computer unattended. Unauthorized users could open any file on the disk. This is where file encryption comes in.
{% endhint %}

#### Disk Encrypotion with eCryptfs and EncFS&#x20;

**eCryptfs provides file system level encryption:**&#x20;

• Uses crypt package&#x20;

• Mount a new directory using the ecryptf type&#x20;

• PAM module provided for automatic mounting options&#x20;

• ecryptfs-util package provides helper utilities&#x20;

**EncFS is similar to Cryptfs but targets non-superusers**

• Allows for the creation of encrypted repositories by standard users

### Working with LUKS

I have added a new disk to my machine and I have created a new volume on that disk using fdisk.

(visit my lpic1 book: [https://borosan.gitbook.io/lpic1-exam-guide/1041-create-partitions-and-filesystems#fdisk](https://borosan.gitbook.io/lpic1-exam-guide/1041-create-partitions-and-filesystems#fdisk)). Now we want to setup a LUKS encrypted volume on that partition. For that we use `cryptsetup` command.

### cryptsetup

By default redhat distributions come with cryptsetup but you might need to install it.

```
[root@rocky8 ~]# cryptsetup luksFormat /dev/sdb1

WARNING!
========
This will overwrite data on /dev/sdb1 irrevocably.

Are you sure? (Type 'yes' in capital letters): YES
Enter passphrase for /dev/sdb1:
Verify passphrase:
[root@rocky8 ~]#
```

it takes a moment  to create LUKS format partition and then come back to our prompt, next we need to mount our partition  using cryptsetup but instead of using luksFormat sub-command we  should use luksOpen:

```
[root@rocky8 ~]# cryptsetup luksOpen /dev/sdb1 myencvol
Enter passphrase for /dev/sdb1:
[root@rocky8 ~]#
```

```
[root@rocky8 ~]# ls -l  /dev/mapper/
total 0
crw-------. 1 root root 10, 236 Apr  4 16:17 control
lrwxrwxrwx. 1 root root       7 Apr  4 18:31 myencvol -> ../dm-2
lrwxrwxrwx. 1 root root       7 Apr  4 16:17 vg--os-root -> ../dm-0
lrwxrwxrwx. 1 root root       7 Apr  4 16:17 vg--os-swap -> ../dm-1

```



```
[root@rocky8 ~]# mkfs.ext4 /dev/mapper/myencvol
mke2fs 1.45.6 (20-Mar-2020)
Creating filesystem with 2617088 4k blocks and 655360 inodes
Filesystem UUID: 68cff192-42fb-4dee-a022-ce7b1092a8a1
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632

Allocating group tables: done
Writing inode tables: done
Creating journal (16384 blocks): done
Writing superblocks and filesystem accounting information: done
```

```
[root@rocky8 ~]# mkdir /mysecret
[root@rocky8 ~]#
[root@rocky8 ~]# mount /dev/mapper/myencvol /mysecret/
[root@rocky8 ~]#
[root@rocky8 ~]# ll /mysecret/
total 16
drwx------. 2 root root 16384 Apr  4 18:42 lost+found
[root@rocky8 ~]#
[root@rocky8 ~]# mount | grep mysecret
/dev/mapper/myencvol on /mysecret type ext4 (rw,relatime,seclabel)
[root@rocky8 ~]# echo "IwasHere" >  /mysecret/IwasHere.txt
[root@rocky8 ~]# ll /mysecret/
total 20
-rw-r--r--. 1 root root     9 Apr  4 18:50 IwasHere.txt
drwx------. 2 root root 16384 Apr  4 18:42 lost+found
```

.

.

.

resources:

[https://blog.cloudflare.com/speeding-up-linux-disk-encryption/](https://blog.cloudflare.com/speeding-up-linux-disk-encryption/)

[https://docs.openstack.org/security-guide/secrets-management/secrets-management-use-cases.html](https://docs.openstack.org/security-guide/secrets-management/secrets-management-use-cases.html)

..

###



File System Encryption with Ecryptfs

Working with LUKS
