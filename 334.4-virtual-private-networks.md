# 334.4 Virtual Private Networks

**Weight:** 4

**Description:** Candidates should be familiar with the use of OpenVPN, IPsec and WireGuard to set up remote access and site to site VPNs.



**Key Knowledge Areas:**

* Understand the principles of bridged and routed VPNs
* Understand the principles and major differences of the OpenVPN, IPsec, IKEv2 and WireGuard protocols
* Configure and operate OpenVPN servers and clients
* Configure and operate IPsec servers and clients using strongSwan
* Configure and operate WireGuard servers and clients
* Awareness of L2TP

**Partial list of the used files, terms and utilities:**

* /etc/openvpn/
* openvpn
* /etc/strongswan.conf
* /etc/strongswan.d/
* /etc/swanctl/swanctl.conf
* /etc/swanctl/
* swanctl
* /etc/wireguard/
* wg
* wg-quick
* ip

## Open VPN

### **What is OpenVPN?**

OpenVPN is Company that created the **OpenVPN Community Edition** VPN server which is open-source and free to use. They also developed the **OpenVPN tunneling protocol** which is a tunneling protocol based on SSL encryption protocol. Many VPN services use this protocol. There is something else which is called OpenVPN Access server which is an enterprise product that has a web Interface and only offers 2 simultaneous connections on the free version.

#### OpenVPN Community Edition (Open Source) <a href="#openvpn-community-edition-open-source" id="openvpn-community-edition-open-source"></a>

OpenVPN is an open-source software application that implements virtual private network (VPN) techniques to create secure point-to-point or site-to-site connections.

OpenVPN can use a variety of methods such as pre-shared secret keys, certificates, or usernames/passwords, to let clients authenticate to the server. OpenVPN uses the OpenSSL protocol and implements many security and control features such as challenge response authentication, single sign-on capability, load balancing and failover features and multi daemon support.

By default OpenVPN works on port 1194 UDP but Open VPN is highly capable of transparently traversing through firewalls especially when the default port is chnaged to 443.

#### Installing OpenVPN

For demonstration we install OpenVPN on rocky linux:

```
[root@rocky8 ~]# dnf install epel-release -y
[root@rocky8 ~]# dnf install openvpn -y
```

Now that OpenVPN is installed. Navigate to its installation folder and download easy-rsa. Easy-RSA builds and manages certificate authorities (CAs).

```
[root@rocky8 ~]# cd /etc/openvpn/
[root@rocky8 openvpn]# wget https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.6/EasyRSA-unix-v3.0.6.tgz
[root@rocky8 openvpn]# tar -xvzf EasyRSA-unix-v3.0.6.tgz
[root@rocky8 openvpn]# mv EasyRSA-v3.0.6 easy-rsa
```

#### Configure Easy-RSA

Next, we need to add and build an SSL certificate. To do that, first, navigate to the easy-rsa directory

```
[root@rocky8 openvpn]# cd /etc/openvpn/easy-rsa
```

for ease of use, lets create a var file, with bellow contents:

```
[root@rocky8 easy-rsa]# vim vars
```

```
set_var EASYRSA "$PWD"
set_var EASYRSA_PKI "$EASYRSA/pki"
set_var EASYRSA_DN "cn_only"
set_var EASYRSA_REQ_COUNTRY "IR"
set_var EASYRSA_REQ_PROVINCE "Teh"
set_var EASYRSA_REQ_CITY "Teh"
set_var EASYRSA_REQ_ORG "LinuxCert CERTIFICATE AUTHORITY"
set_var EASYRSA_REQ_EMAIL "admin@linuxcert"
set_var EASYRSA_REQ_OU "LinuxCert EASY CA"
set_var EASYRSA_KEY_SIZE 2048
set_var EASYRSA_ALGO rsa
set_var EASYRSA_CA_EXPIRE 7500
set_var EASYRSA_CERT_EXPIRE 365
set_var EASYRSA_NS_SUPPORT "no"
set_var EASYRSA_NS_COMMENT "LinuxCert CERTIFICATE AUTHORITY"
set_var EASYRSA_EXT_DIR "$EASYRSA/x509-types"
set_var EASYRSA_SSL_CONF "$EASYRSA/openssl-easyrsa.cnf"
set_var EASYRSA_DIGEST "sha256"
```

> You can change the value of country, city, province, and email according to your requirements.

Now, initiate the PKI directory with the following command.

```
[root@rocky8 easy-rsa]# ./easyrsa init-pki
```

Finally, You can build your CA certificate.

```
[root@rocky8 easy-rsa]# sudo ./easyrsa build-ca
```

#### Generate Server Certificate Files

Use the following command to get your key-pair and certificate request.

```
[root@rocky8 easy-rsa]# sudo ./easyrsa gen-req myov-server nopass
.
.
.
Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa/pki/reqs/myov-server.req
key: /etc/openvpn/easy-rsa/pki/private/myov-server.key
```

#### Sign the Server Key With CA

To sign your server key with the CA, run the following command.

```
[root@rocky8 easy-rsa]# sudo ./easyrsa sign-req server myov-server
.
.
.
Certificate created at: /etc/openvpn/easy-rsa/pki/issued/myov-server.crt
```

We need the Diffie-Hellman key for key exchanging purposes. Generate the key by running the following command.

```
[root@rocky8 easy-rsa]# sudo ./easyrsa gen-dh
```

Next, copy all these files to the **/etc/openvpn/server/** directory.

```
[root@rocky8 easy-rsa]# cp pki/ca.crt /etc/openvpn/server/
[root@rocky8 easy-rsa]# cp pki/dh.pem /etc/openvpn/server/
[root@rocky8 easy-rsa]# cp pki/private/myov-server.key /etc/openvpn/server/
[root@rocky8 easy-rsa]# cp pki/issued/myov-server.crt /etc/openvpn/server/
```

#### Generate Client Key and Certificate

You can get the client key by running the following command.

```
[root@rocky8 easy-rsa]# sudo ./easyrsa gen-req client nopass
.
.
.
Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa/pki/reqs/client.req
key: /etc/openvpn/easy-rsa/pki/private/client.key
```

Next sign your client key with the generated CA certificate.

```
[root@rocky8 easy-rsa]# sudo ./easyrsa sign-req client client
.
.
.
Certificate created at: /etc/openvpn/easy-rsa/pki/issued/client.crt
```

Copy these files to the **/etc/openvpn/client/** directory

```
[root@rocky8 easy-rsa]# cp pki/ca.crt /etc/openvpn/client/
[root@rocky8 easy-rsa]# cp pki/issued/client.crt /etc/openvpn/client/
[root@rocky8 easy-rsa]# cp pki/private/client.key /etc/openvpn/client/
```

### Configure OpenVPN Server

Make and open a new config file in the client directory with the following command.

```
[root@rocky8 easy-rsa]# vim /etc/openvpn/server/server.conf
```

Then add the following code lines in the file.

```
port 1194
proto udp
dev tun
ca /etc/openvpn/server/ca.crt
cert /etc/openvpn/server/myov-server.crt
key /etc/openvpn/server/myov-server.key
dh /etc/openvpn/server/dh.pem
server 10.8.0.0 255.255.255.0
push "redirect-gateway def1"
push "dhcp-option DNS 208.67.222.222"
push "dhcp-option DNS 208.67.220.220"
duplicate-cn
cipher AES-256-CBC
tls-version-min 1.2
tls-cipher TLS-DHE-RSA-WITH-AES-256-GCM-SHA384:TLS-DHE-RSA-WITH-AES-256-CBC-SHA256:TLS-DHE-RSA-WITH-AES-128-GCM-SHA256:TLS-DHE-RSA-WITH-AES-128-CBC-SHA256
auth SHA512
auth-nocache
keepalive 20 60
persist-key
persist-tun
compress lz4
daemon
user nobody
group nobody
log-append /var/log/openvpn.log
verb 3
```

> All OpenVPN configuration files should be configured under /etc/openvpn directory but by default no configuration files are found here. So we should either create new ones (which seems complicated) or we can easily copy sample configuration files from /usr/share/doc/openvpn-x to /etc/openvpn directory and modify them

#### Start and Enable OpenVPN Service

Your OpenVPN is ready to launch. Start and enable the server using the following commands.

```
[root@rocky8 easy-rsa]# systemctl start openvpn-server@server
```

A new network interface **tun0** will be created on the successful start of the OpenVPN server. Run `ifconfig` command to see the details.

### Generate the Client Configuration File

The next step is to connect the client to the OpenVPN server. We need the client configuration file for that. To generate the client configuration file, run the following command.

```
[root@rocky8 easy-rsa]# vim /etc/openvpn/client/client.ovpn
```

Now, copy and paste the following code into the file.

```
client
dev tun
proto udp
remote vpn-server-ip 1194
ca ca.crt
cert client.crt
key client.key
cipher AES-256-CBC
auth SHA512
auth-nocache
tls-version-min 1.2
tls-cipher TLS-DHE-RSA-WITH-AES-256-GCM-SHA384:TLS-DHE-RSA-WITH-AES-256-CBC-SHA256:TLS-DHE-RSA-WITH-AES-128-GCM-SHA256:TLS-DHE-RSA-WITH-AES-128-CBC-SHA256
resolv-retry infinite
compress lz4
nobind
persist-key
persist-tun
mute-replay-warnings
verb 3
```

### Configure Routing

Set OpenVPN service settings with the following commands to allow it through the firewall.

```
firewall-cmd --permanent --add-service=openvpn
firewall-cmd --permanent --zone=trusted --add-service=openvpn
firewall-cmd --permanent --zone=trusted --add-interface=tun0
firewall-cmd --add-masquerade
firewall-cmd --permanent --add-masquerade
```

Set the routing to forward the incoming traffic from the VPN to the local network.

```
routecnf=$(ip route get 8.8.8.8 | awk 'NR==1 {print $(NF-2)}')
firewall-cmd --permanent --direct --passthrough ipv4 -t nat -A POSTROUTING -s 10.8.0.0/24 -o $routecnf -j MASQUERADE
```

Reload to make the changes effective.

```
firewall-cmd --reload
```

### Install and Use OpenVPN in Client Machine

You have to install epel-release and OpenVPN as you did on the server-side.

```
[root@client1 ~]# dnf install epel-release -y
[root@client1 ~]# dnf install openvpn -y
```

Now copy the client config files from the server using the command given below.

```
sudo scp -r root@vpn-server-ip:/etc/openvpn/client .
```

Go to the client directory and connect to the OpenVPN server using the following commands.

```
[root@client1 ~]# cd client/
[root@client1 client]# openvpn --config client.ovpn
```

Run the `ifconfig tun0` to see the assigned IP address.

### openvpn command

Lets take a look at two important openvpn command options:

**--mlok**

Using this option ensures that key material and tunnel data are never written to disk due to virtual memory paging operations which occur under most modern operating systems. It ensures that even if an attacker was able to crack the box running OpenVPN, he would not be able to scan the system swap file to recover previously used ephemeral keys

The downside of using **--mlock** is that it will reduce the amount of physical memory available to other applications.

**--push option**

Push a config file option back to the client for remote execution. Note that **option** must be enclosed in double quotes (""). The client must specify **--pull** in its config file. The set of options which can be pushed is limited by both feasibility and security. Some options such as those which would execute scripts are banned, since they would effectively allow a compromised server to execute arbitrary code on the client. Other options such as TLS or MTU parameters cannot be pushed because the client needs to know them before the connection to the server can be initiated.This is a partial list of options which can currently be pushed: **--route, --route-gateway, --route-delay, --redirect-gateway,** **--ip-win32, --dhcp-option,** **--inactive, --ping, --ping-exit, --ping-restart,** **--setenv,** **--auth-token,** **--persist-key, --persist-tun, --echo,** **--comp-lzo,** **--socket-flags,** **--sndbuf, --rcvbuf**

{% hint style="success" %}
for more info review my LPIC-2 book: [https://borosan.gitbook.io/lpic2-exam-guide/2125-openvpn#openvpn](https://borosan.gitbook.io/lpic2-exam-guide/2125-openvpn#openvpn)
{% endhint %}

## Working with IPSec Server and Clients

### ipsec concpet

IPSec create boundary between protected and unprotected network. Traffic traversing the boundary is a subject to access controls that specified by user or administrator responsible for IPSec configuration. From the control, the traffic maybe cross the boundary with afforded security services via AH or ESP, or are discarded.

<figure><img src=".gitbook/assets/ipsec-concepts.jpg" alt=""><figcaption><p>Top Level IPSec Processing Model</p></figcaption></figure>

### **IPSec Policy**

Fundamental of IPSec service is the concept of security policy that determined by two database. Those are, Security Policy Database (SPD), and Security Association Database (SAD). This policy applied to each IP packet that transit from a source to a destination.

**1.**_**Security Association**_\
Security Association is a key concept to both node exchange information about authentication and encryption mechanism. An association is a one-way logical connection between a sender and a receiver that affords security services to the traffic carried on it

<figure><img src=".gitbook/assets/IPsec-architecture.jpg" alt=""><figcaption><p>IPSec Architecture</p></figcaption></figure>

There are three parameter that identify the security association:\
1\. _Security Parameters Index_ (SPI), bit string carry IPSec protocol header information to enable receiving system to select packet that will be received\
2\. _IP Destination Address_, the endpoint address of IPSec\
3\. _Security Protocol Identifier_, this field from the outer IP header indicates whether the association is an AH or ESP security association

**2.**_**Security Association Database**_

In each IPsec implementation, there is a nominal Security Association Database that defines the parameters associated with each SA. This database stored a parameter to build IKE SA and IPSec SA. Below the parameter in an SAD entry:\
1\. **Security Parameter Index**: A 32-bit value selected by the receiving end of an SA to uniquely identify the SA\
2\. **Sequence Number Counter**: A 32-bit value used to generate the Sequence Number field in IPSec Protocol headers.\
3\. **Sequence Counter Overflow**: A flag indicating whether overflow of the Sequence Number Counter should generate an auditable event and prevent further transmission of packets on this SA\
4\. **Anti-Replay Window**: Used to determine whether an inbound AH or ESP packet is a replay\
5\. **AH Information**: Authentication algorithm, keys, key lifetimes, and related parameters being used with AH\
6\. **ESP Information**: Encryption and authentication algorithm, keys, initialization values, key lifetimes, and related parameters being used with ESP (required for ESP implementations).\
7\. **Lifetime of this Security Association**: A time interval or byte count after which an SA must be replaced with a new SA (and new SPI) or terminated, plus an indication of which of these actions should occur\
8\. **IPsec Protocol Mode**: Tunnel, transport, or wildcard\
9\. **Path MTU**: Any observed path maximum transmission unit (maximum size of a packet that can be transmitted without fragmentation) and aging variables

3._**Security Policy Database**_

Security policy stores the IP traffic that related to specific SA, it means SPD contains the entries, each entry defines a subset of IP traffic and points to an SA for that traffic. Each SPD entry is defined by IP and upper-layer protocol field values, called selector. These selector is used to filter outgoing traffic in order to map it in to a particular SA. The following selectors determine an SPD entry:\
1\. **Remote IP Address**: This may be a single IP address, an enumerated list or range of addresses, or a wildcard (mask) address for remote private network\
2\. **Local IP Address**: This may be a single IP address, an enumerated list or range of addresses, or a wildcard (mask) address for local private network\
3\. **Next Layer Protocol**: The IP protocol header (IPv4, IPv6, or IPv6 Extension) includes a field (Protocol for IPv4, Next Header for IPv6 or IPv6 Extension) that designates the protocol operating over IP\
4\. **Name**: A user identifier from the operating system. This is not a field in the IP or upper-layer headers but is available if IPsec is running on the same operating system as the user.\
5\. **Local and Remote Ports**: These may be individual TCP or UDP port values, an enumerated list of ports, or a wildcard port.

### **IPSec Protocol**

IPSec using protocol Authentication Header (AH), and Encapsulation Security Payload (ESP), to provide traffic security services.

* Authentication Header (AH)

In this protocol, IP header and data payload is hashed. From this hash, a new AH header is build which is appended to the packet. This new packet is transmitted via router where the router hashes the header and the payload. Both the hashes need to be exactly matched. Even a single bit is changed, the AH header will not match.

#### Encapsulating Security Payload (ESP) <a href="#encapsulatingsecuritypayloadesp" id="encapsulatingsecuritypayloadesp"></a>

This is a security protocol to provide encryption and integrity to the data packets. The ESP is added after the standard IP header. As it contains standard IP header, it can be routed easily with standard IP devices. This makes it backwards-compatible with IP routers and even those devices that were not designed to operate with IPsec. ESP is performed at the IP packet layer. It contains six parts of which two parts are only authenticated (Security Parameter Index, Sequence Number) whereas the rest of the four parts are encrypted during transmission (Payload Data, Padding, Pad Length and Next Header). It supports multiple encryption protocols and is up to the user to decide which one to opt.





.

.

.

resources:

[https://en.wikipedia.org/wiki/OpenVPN](https://en.wikipedia.org/wiki/OpenVPN)

[https://www.geeksforgeeks.org/how-to-install-and-setup-the-openvpn-server-on-ubuntu-debian/](https://www.geeksforgeeks.org/how-to-install-and-setup-the-openvpn-server-on-ubuntu-debian/)

[https://vitux.com/how-to-install-openvpn-on-almalinux-8-centos-8-or-rocky-linux-8/](https://vitux.com/how-to-install-openvpn-on-almalinux-8-centos-8-or-rocky-linux-8/)

[https://openvpn.net/community-resources/reference-manual-for-openvpn-2-4/](https://openvpn.net/community-resources/reference-manual-for-openvpn-2-4/)

.
