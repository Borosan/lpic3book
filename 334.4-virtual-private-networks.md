# 334.4 Virtual Private Networks

**Weight:** 4

**Description:** Candidates should be familiar with the use of OpenVPN, IPsec and WireGuard to set up remote access and site to site VPNs.



**Key Knowledge Areas:**

* Understand the principles of bridged and routed VPNs
* Understand the principles and major differences of the OpenVPN, IPsec, IKEv2 and WireGuard protocols
* Configure and operate OpenVPN servers and clients
* Configure and operate IPsec servers and clients using strongSwan
* Configure and operate WireGuard servers and clients
* Awareness of L2TP

**Partial list of the used files, terms and utilities:**

* /etc/openvpn/
* openvpn
* /etc/strongswan.conf
* /etc/strongswan.d/
* /etc/swanctl/swanctl.conf
* /etc/swanctl/
* swanctl
* /etc/wireguard/
* wg
* wg-quick
* ip

## Open VPN

### **What is OpenVPN?**

OpenVPN is Company that created the **OpenVPN Community Edition** VPN server which is open-source and free to use. They also developed the **OpenVPN tunneling protocol** which is a tunneling protocol based on SSL encryption protocol. Many VPN services use this protocol. There is something else which is called OpenVPN Access server which is an enterprise product that has a web Interface and only offers 2 simultaneous connections on the free version.

#### OpenVPN Community Edition (Open Source) <a href="#openvpn-community-edition-open-source" id="openvpn-community-edition-open-source"></a>

OpenVPN is an open-source software application that implements virtual private network (VPN) techniques to create secure point-to-point or site-to-site connections.

OpenVPN can use a variety of methods such as pre-shared secret keys, certificates, or usernames/passwords, to let clients authenticate to the server. OpenVPN uses the OpenSSL protocol and implements many security and control features such as challenge response authentication, single sign-on capability, load balancing and failover features and multi daemon support.

By default OpenVPN works on port 1194 UDP but Open VPN is highly capable of transparently traversing through firewalls especially when the default port is chnaged to 443.

#### Installing OpenVPN

For demonstration we install OpenVPN on rocky linux:

```
[root@rocky8 ~]# dnf install epel-release -y
[root@rocky8 ~]# dnf install openvpn -y
```

Now that OpenVPN is installed. Navigate to its installation folder and download easy-rsa. Easy-RSA builds and manages certificate authorities (CAs).

```
[root@rocky8 ~]# cd /etc/openvpn/
[root@rocky8 openvpn]# wget https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.6/EasyRSA-unix-v3.0.6.tgz
[root@rocky8 openvpn]# tar -xvzf EasyRSA-unix-v3.0.6.tgz
[root@rocky8 openvpn]# mv EasyRSA-v3.0.6 easy-rsa
```

#### Configure Easy-RSA

Next, we need to add and build an SSL certificate. To do that, first, navigate to the easy-rsa directory

```
[root@rocky8 openvpn]# cd /etc/openvpn/easy-rsa
```

for ease of use, lets create a var file, with bellow contents:

```
[root@rocky8 easy-rsa]# vim vars
```

```
set_var EASYRSA "$PWD"
set_var EASYRSA_PKI "$EASYRSA/pki"
set_var EASYRSA_DN "cn_only"
set_var EASYRSA_REQ_COUNTRY "IR"
set_var EASYRSA_REQ_PROVINCE "Teh"
set_var EASYRSA_REQ_CITY "Teh"
set_var EASYRSA_REQ_ORG "LinuxCert CERTIFICATE AUTHORITY"
set_var EASYRSA_REQ_EMAIL "admin@linuxcert"
set_var EASYRSA_REQ_OU "LinuxCert EASY CA"
set_var EASYRSA_KEY_SIZE 2048
set_var EASYRSA_ALGO rsa
set_var EASYRSA_CA_EXPIRE 7500
set_var EASYRSA_CERT_EXPIRE 365
set_var EASYRSA_NS_SUPPORT "no"
set_var EASYRSA_NS_COMMENT "LinuxCert CERTIFICATE AUTHORITY"
set_var EASYRSA_EXT_DIR "$EASYRSA/x509-types"
set_var EASYRSA_SSL_CONF "$EASYRSA/openssl-easyrsa.cnf"
set_var EASYRSA_DIGEST "sha256"
```

> You can change the value of country, city, province, and email according to your requirements.

Now, initiate the PKI directory with the following command.

```
[root@rocky8 easy-rsa]# ./easyrsa init-pki
```

Finally, You can build your CA certificate.

```
[root@rocky8 easy-rsa]# sudo ./easyrsa build-ca
```

#### Generate Server Certificate Files

Use the following command to get your key-pair and certificate request.

```
[root@rocky8 easy-rsa]# sudo ./easyrsa gen-req myov-server nopass
.
.
.
Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa/pki/reqs/myov-server.req
key: /etc/openvpn/easy-rsa/pki/private/myov-server.key
```

#### Sign the Server Key With CA

To sign your server key with the CA, run the following command.

```
[root@rocky8 easy-rsa]# sudo ./easyrsa sign-req server myov-server
.
.
.
Certificate created at: /etc/openvpn/easy-rsa/pki/issued/myov-server.crt
```

We need the Diffie-Hellman key for key exchanging purposes. Generate the key by running the following command.

```
[root@rocky8 easy-rsa]# sudo ./easyrsa gen-dh
```

Next, copy all these files to the **/etc/openvpn/server/** directory.

```
[root@rocky8 easy-rsa]# cp pki/ca.crt /etc/openvpn/server/
[root@rocky8 easy-rsa]# cp pki/dh.pem /etc/openvpn/server/
[root@rocky8 easy-rsa]# cp pki/private/myov-server.key /etc/openvpn/server/
[root@rocky8 easy-rsa]# cp pki/issued/myov-server.crt /etc/openvpn/server/
```

#### Generate Client Key and Certificate

You can get the client key by running the following command.

```
[root@rocky8 easy-rsa]# sudo ./easyrsa gen-req client nopass
.
.
.
Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa/pki/reqs/client.req
key: /etc/openvpn/easy-rsa/pki/private/client.key
```

Next sign your client key with the generated CA certificate.

```
[root@rocky8 easy-rsa]# sudo ./easyrsa sign-req client client
.
.
.
Certificate created at: /etc/openvpn/easy-rsa/pki/issued/client.crt
```

Copy these files to the **/etc/openvpn/client/** directory

```
[root@rocky8 easy-rsa]# cp pki/ca.crt /etc/openvpn/client/
[root@rocky8 easy-rsa]# cp pki/issued/client.crt /etc/openvpn/client/
[root@rocky8 easy-rsa]# cp pki/private/client.key /etc/openvpn/client/
```

### Configure OpenVPN Server

Make and open a new config file in the client directory with the following command.

```
[root@rocky8 easy-rsa]# vim /etc/openvpn/server/server.conf
```

Then add the following code lines in the file.

```
port 1194
proto udp
dev tun
ca /etc/openvpn/server/ca.crt
cert /etc/openvpn/server/myov-server.crt
key /etc/openvpn/server/myov-server.key
dh /etc/openvpn/server/dh.pem
server 10.8.0.0 255.255.255.0
push "redirect-gateway def1"
push "dhcp-option DNS 208.67.222.222"
push "dhcp-option DNS 208.67.220.220"
duplicate-cn
cipher AES-256-CBC
tls-version-min 1.2
tls-cipher TLS-DHE-RSA-WITH-AES-256-GCM-SHA384:TLS-DHE-RSA-WITH-AES-256-CBC-SHA256:TLS-DHE-RSA-WITH-AES-128-GCM-SHA256:TLS-DHE-RSA-WITH-AES-128-CBC-SHA256
auth SHA512
auth-nocache
keepalive 20 60
persist-key
persist-tun
compress lz4
daemon
user nobody
group nobody
log-append /var/log/openvpn.log
verb 3
```

> All OpenVPN configuration files should be configured under /etc/openvpn directory but by default no configuration files are found here. So we should either create new ones (which seems complicated) or we can easily copy sample configuration files from /usr/share/doc/openvpn-x to /etc/openvpn directory and modify them

#### Start and Enable OpenVPN Service

Your OpenVPN is ready to launch. Start and enable the server using the following commands.

```
[root@rocky8 easy-rsa]# systemctl start openvpn-server@server
```

A new network interface **tun0** will be created on the successful start of the OpenVPN server. Run `ifconfig` command to see the details.

### Generate the Client Configuration File

The next step is to connect the client to the OpenVPN server. We need the client configuration file for that. To generate the client configuration file, run the following command.

```
[root@rocky8 easy-rsa]# vim /etc/openvpn/client/client.ovpn
```

Now, copy and paste the following code into the file.

```
client
dev tun
proto udp
remote vpn-server-ip 1194
ca ca.crt
cert client.crt
key client.key
cipher AES-256-CBC
auth SHA512
auth-nocache
tls-version-min 1.2
tls-cipher TLS-DHE-RSA-WITH-AES-256-GCM-SHA384:TLS-DHE-RSA-WITH-AES-256-CBC-SHA256:TLS-DHE-RSA-WITH-AES-128-GCM-SHA256:TLS-DHE-RSA-WITH-AES-128-CBC-SHA256
resolv-retry infinite
compress lz4
nobind
persist-key
persist-tun
mute-replay-warnings
verb 3
```

### Configure Routing

Set OpenVPN service settings with the following commands to allow it through the firewall.

```
firewall-cmd --permanent --add-service=openvpn
firewall-cmd --permanent --zone=trusted --add-service=openvpn
firewall-cmd --permanent --zone=trusted --add-interface=tun0
firewall-cmd --add-masquerade
firewall-cmd --permanent --add-masquerade
```

Set the routing to forward the incoming traffic from the VPN to the local network.

```
routecnf=$(ip route get 8.8.8.8 | awk 'NR==1 {print $(NF-2)}')
firewall-cmd --permanent --direct --passthrough ipv4 -t nat -A POSTROUTING -s 10.8.0.0/24 -o $routecnf -j MASQUERADE
```

Reload to make the changes effective.

```
firewall-cmd --reload
```

### Install and Use OpenVPN in Client Machine

You have to install epel-release and OpenVPN as you did on the server-side.

```
[root@client1 ~]# dnf install epel-release -y
[root@client1 ~]# dnf install openvpn -y
```

Now copy the client config files from the server using the command given below.

```
sudo scp -r root@vpn-server-ip:/etc/openvpn/client .
```

Go to the client directory and connect to the OpenVPN server using the following commands.

```
[root@client1 ~]# cd client/
[root@client1 client]# openvpn --config client.ovpn
```

Run the `ifconfig tun0` to see the assigned IP address.





## Working with IPSec Server and Clients



.

.

.

resources:

[https://en.wikipedia.org/wiki/OpenVPN](https://en.wikipedia.org/wiki/OpenVPN)

[https://www.geeksforgeeks.org/how-to-install-and-setup-the-openvpn-server-on-ubuntu-debian/](https://www.geeksforgeeks.org/how-to-install-and-setup-the-openvpn-server-on-ubuntu-debian/)

.
