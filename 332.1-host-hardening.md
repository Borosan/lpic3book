# 332.1 Host Hardening

#### _Topic 332: Host Security_

**Weight:** 5

**Description:** Candidates should be able to secure computers running Linux against common threats.



**Key Knowledge Areas:**

* Configure BIOS and boot loader (GRUB 2) security
* Disable unused software and services
* Understand and drop unnecessary capabilities for specific systemd units and the entire system
* Understand and configure Address Space Layout Randomization (ASLR), Data Execution Prevention (DEP) and Exec-Shield
* Black and white list USB devices attached to a computer using USBGuard
* Create an SSH CA, create SSH certificates for host and user keys using the CA and configure OpenSSH to use SSH certificates
* Work with chroot environments
* Use systemd units to limit the system calls and capabilities available to a process
* Use systemd units to start processes with limited or no access to specific files and devices
* Use systemd units to start processes with dedicated temporary and /dev directories and without network access
* Understand the implications of Linux Meltdown and Spectre mitigations and enable/disable the mitigations
* Awareness of polkit
* Awareness of the security advantages of virtualization and containerization

**The following is a partial list of the used files, terms and utilities:**

* grub.cfg
* systemctl
* getcap
* setcap
* capsh
* sysctl
* /etc/sysctl.conf
* /etc/usbguard/usbguard-daemon.conf
* /etc/usbguard/rules.conf
* usbguard
* ssh-keygen
* /etc/ssh/
* \~/.ssh/
* /etc/ssh/sshd\_config
* chroot



## Kernel Security

#### &#x20;Disabling unnecessary software:&#x20;

• Every running program presents a possible security threat.&#x20;

• Disabling unused services is a good security practice.&#x20;

• Use systemctl and chkconfig to disable services.&#x20;

• Commonly disabled services include atd, ava hi-daemon, cups.

#### &#x20;Limiting resource usage:&#x20;

• The user may limit system resources such as threads, open files, and memory.&#x20;

> There are both soft and hard limits:&#x20;
>
> A regular user may temporarily bypass soft limits Hard limits may only be raised by root and are enforced by the kernel A user or group may apply limits

• The **paml\_limits.so** module allows operators to control how much of any one resource a user may access through hard and soft limits.

• Most systems come with pam.so preloaded.&#x20;

• The ulimit command may be used to adjust these limits at runtime.&#x20;

> Here are some of the more common options for ulimit:
>
> \-a: All current limits are reported&#x20;
>
> \-f: The maximum size of files written by the shell and its children&#x20;
>
> \-t: The maximum amount of cpu time in seconds&#x20;
>
> \-u: The maximum number of processes available to a single user&#x20;
>
> \-T: The maximum number of threads

• Limits may be set persistently in /etc/security/limits.conf.&#x20;

{% hint style="success" %}
visit my LPIC1: [https://borosan.gitbook.io/lpic1-exam-guide/1101-perform-security-administration-tasks#ulimit](https://borosan.gitbook.io/lpic1-exam-guide/1101-perform-security-administration-tasks#ulimit)
{% endhint %}

#### Tuning kernel parameters:&#x20;

• The sysctl command is capable of displaying and setting kernel parameters.

```
[root@rocky8 ~]# sysctl -a | less
[root@rocky8 ~]# sysctl -ar icmp
net.ipv4.icmp_echo_ignore_all = 0
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_errors_use_inbound_ifaddr = 0
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.icmp_msgs_burst = 50
net.ipv4.icmp_msgs_per_sec = 1000
net.ipv4.icmp_ratelimit = 1000
net.ipv4.icmp_ratemask = 6168
net.ipv6.icmp.ratelimit = 1000
net.netfilter.nf_conntrack_icmp_timeout = 30
net.netfilter.nf_conntrack_icmpv6_timeout = 30
```

{% hint style="info" %}
**Sysctl Review**&#x20;

**View Settings:**&#x20;

sysctl -a&#x20;

sysctl -ar \<search\_pattern>&#x20;

procfs&#x20;

**Setting parameters:**&#x20;

sysctl -w  \<param>=\<value>

**Persist changes:**&#x20;

etc/sysctl.conf
{% endhint %}

{% hint style="success" %}
for full review visit my LPIC2 book: [https://borosan.gitbook.io/lpic2-exam-guide/2042-adjusting-storage-device-access#sysctl](https://borosan.gitbook.io/lpic2-exam-guide/2042-adjusting-storage-device-access#sysctl)
{% endhint %}

• Parameters map to the procfs filesystem.&#x20;

```
[root@rocky8 ~]# ls -l  /proc/sys
total 0
dr-xr-xr-x. 1 root root 0 Sep  6 07:57 abi
dr-xr-xr-x. 1 root root 0 Sep  6 04:41 crypto
dr-xr-xr-x. 1 root root 0 Sep  6 07:57 debug
dr-xr-xr-x. 1 root root 0 Sep  6 07:57 dev
dr-xr-xr-x. 1 root root 0 Apr  4 16:17 fs
dr-xr-xr-x. 1 root root 0 Apr  4 16:17 kernel
dr-xr-xr-x. 1 root root 0 Sep  6 05:46 net
dr-xr-xr-x. 1 root root 0 Sep  6 07:57 user
dr-xr-xr-x. 1 root root 0 Sep  6 07:57 vm

[root@rocky8 ~]# ll /proc/sys/net/ipv4/icmp*
-rw-r--r--. 1 root root 0 Sep  6 08:05 /proc/sys/net/ipv4/icmp_echo_ignore_all
-rw-r--r--. 1 root root 0 Sep  6 07:57 /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts
-rw-r--r--. 1 root root 0 Sep  6 07:57 /proc/sys/net/ipv4/icmp_errors_use_inbound_ifaddr
-rw-r--r--. 1 root root 0 Sep  6 07:57 /proc/sys/net/ipv4/icmp_ignore_bogus_error_responses
-rw-r--r--. 1 root root 0 Sep  6 07:57 /proc/sys/net/ipv4/icmp_msgs_burst
-rw-r--r--. 1 root root 0 Sep  6 07:57 /proc/sys/net/ipv4/icmp_msgs_per_sec
-rw-r--r--. 1 root root 0 Sep  6 07:57 /proc/sys/net/ipv4/icmp_ratelimit
-rw-r--r--. 1 root root 0 Sep  6 07:57 /proc/sys/net/ipv4/icmp_ratemask

```

{% hint style="success" %}
visit my LPIC1 book: [https://borosan.gitbook.io/lpic1-exam-guide/1011-determine-and-configure-hardware-settings#proc](https://borosan.gitbook.io/lpic1-exam-guide/1011-determine-and-configure-hardware-settings#proc)
{% endhint %}

• Kernel parameters set persistently in the file /etc/sysctl.conf.&#x20;

> See kernel-docs for additional information.

{% hint style="danger" %}
in modern linux distributions, the location of configs might be different:

\[root@rocky8 \~]# cat /etc/sysctl.conf sysctl settings are defined through files in /usr/lib/sysctl.d/, /run/sysctl.d/, and /etc/sysctl.d/.

Vendors settings live in /usr/lib/sysctl.d/. To override a whole file, create a new file with the same in /etc/sysctl.d/ and put new settings there. To override only specific settings, add a file with a lexically later name in /etc/sysctl.d/ and put new settings there.

For more information, see sysctl.conf(5) and sysctl.d(5).
{% endhint %}

#### USB Gurd

The **USBGuard** software framework provides system protection against intrusive USB devices by implementing basic whitelisting and blacklisting capabilities based on device attributes. To enforce a user-defined policy, **USBGuard** uses the Linux kernel USB device authorization feature. The **USBGuard** framework provides the following components:

* The daemon component with an inter-process communication (IPC) interface for dynamic interaction and policy enforcement.
* The command-line interface to interact with a running **USBGuard** instance.
* The rule language for writing USB device authorization policies.
* The C++ API for interacting with the daemon component implemented in a shared library.

{% hint style="info" %}
**To create the initial rule set:**

usbguard generate-policy > /etc/usbguard/rules.conf

**To customize the USBGuard rule set:**

edit the `/etc/usbguard/rules.conf`

**To start the USBGuard daemon`:`**

systemctl enable usbguard.service `--now`

**To list all USB devices recognized by USBGuard`:`**

usbguard list-devices

**To authorize a device to interact with the system:**

usbguard allow-device \<device-num>

**To deauthorize and remove a device from the system:**

usbguard reject-device \<device-num>

**To just deauthorize a device:**

usbguard block-device \<device-num>



**USBGuard** uses the _block_ and _reject_ terms with the following meaning:

* block - do not talk to this device for now
* reject - ignore this device as if did not exist

To see all options  use `usbguard --help` command
{% endhint %}

{% hint style="info" %}
#### Creating a White List and a Black List

The `usbguard-daemon.conf` file is loaded by the `usbguard` daemon after it parses its command-line options and is used to configure runtime parameters of the daemon. To override the default configuration file (`/etc/usbguard/usbguard-daemon.conf`), use the `-c` command-line option. See the `usbguard-daemon(8)` man page for further details.

To create a white list or a black list, edit the `usbguard-daemon.conf` file and use its options
{% endhint %}

{% hint style="warning" %}
**Important**

The daemon provides the **USBGuard** public IPC interface. In Red Hat Enterprise Linux, the access to this interface is by default limited to the `root` user only. Consider setting either the `IPCAccessControlFiles` option (recommended) or the `IPCAllowedUsers` and `IPCAllowedGroups` options to limit access to the IPC interface. Do not leave the ACL unconfigured as this exposes the IPC interface to all local users and it allows them to manipulate the authorization state of USB devices and modify the **USBGuard** policy.
{% endhint %}

#### Managing ASLR:&#x20;

• ASLR stands for Address Space Layout Randomization.&#x20;

• It ensures that every time a program loads, it loads into a different place in memory.

{% hint style="info" %}
Setting or Un-setting ASLR:

&#x20;ALSR is controlled by the kernel parameter **`kernel.randomize_va_space`**&#x20;

This value may be controlled using sysctl or in /etc/sysctl.conf (see notes earlier in this section)&#x20;

* A value of 2 means ALSR is fully functional&#x20;
* A value of 1 means ALSR is operating in conservative mode&#x20;
* A value of 0 means ALSR is disabled
{% endhint %}

#### The NX bit:&#x20;

• The NX bit is a CPU feature.&#x20;

• It prevents execution from protected memory areas. By limiting executable memory space, malicious programs have a harder time executing arbitrary code

{% hint style="info" %}
**Verify NX bit set**&#x20;

As NX is at the CPU level, you must look at CPU information to verify it:&#x20;

`grep -Fw nx /proc/cpuinfo`
{% endhint %}

• Exec-Shield is a software solution for the same problem designed to support CPUs without this feature.

#### ICMP security settings:

&#x20;• Network security may be enhanced through kernel parameter tuning.&#x20;

• Disabling ICMP is a common security measure that may be achieved by setting the parameter net.ipv4.icmp\_echo\_ignore\_all to 1.

```
[root@rocky8 ~]# sysctl -w net.ipv4.icmp_echo_ignore_all=1
net.ipv4.icmp_echo_ignore_all = 1
```

#### Chroot Environments&#x20;

• A chroot environment is a ‘fake root’ that is set for a specific user and process.&#x20;

• The chroot command is used by root to create the environment using a pre-configured area in the filesystem.&#x20;

• An unprivileged process is unable to access files outside of a chroot environment.&#x20;

• Be mindful of hard links in chroot environments.they can get out!

{% hint style="info" %}
Modern technologies allow isolation of the entire system as opposed to simply the file system:&#x20;

• **Virtualization** is similar to a chroot environment but at a much more advanced level.&#x20;

• **Containerization** is similar in nature when it comes to resource segmentation and process isolation.
{% endhint %}

#### polkit

PolKit (formerly known as PolicyKit) is an application framework that acts as a negotiator between the unprivileged user session and the privileged system context. Whenever a process from the user session tries to carry out an action in the system context, PolKit is queried. Based on its configuration—specified in a so-called “policy”—the answer could be “yes”, “no”, or “needs authentication”. Unlike classical privilege authorization programs such as sudo, PolKit does not grant `root` permissions to an entire session, but only to the action in question.

## Securing Grub

You may be interested in how to prevent ordinary users from doing whatever they like, if you share your computer with other people.

&#x20;One thing which could be a security hole is that the user can do too many things with GRUB, because GRUB allows one to modify its configuration and run arbitrary commands at run-time. So it is necessary to disable all the interactive operations.

Thus, GRUB provides a password feature, so that only administrators can start the interactive operations (i.e. editing menu entries and entering the command-line interface).

{% hint style="info" %}
Securing Grub :

* **Grub 1:** does not support unique user accounts, only passwords for entries Specify password agoodpw in menu entry in grub.conf in order to password protect Securing&#x20;
* **Grub 2:** Grub 2 allows for a two types of password A global password that protects editing menu entries An operating system password that protects booting specific menu entries.
{% endhint %}

lets take a look at grub configurations:

```
[root@centos7 grub.d]# pwd
/etc/grub.d
[root@centos7 grub.d]# ll
total 72
-rwxr-xr-x. 1 root root  8702 Jul 28  2020 00_header
-rwxr-xr-x. 1 root root  1043 Mar 21  2019 00_tuned
-rwxr-xr-x. 1 root root   232 Jul 28  2020 01_users
-rwxr-xr-x. 1 root root 10781 Jul 28  2020 10_linux
-rwxr-xr-x. 1 root root 10275 Jul 28  2020 20_linux_xen
-rwxr-xr-x. 1 root root  2559 Jul 28  2020 20_ppc_terminfo
-rwxr-xr-x. 1 root root 11169 Jul 28  2020 30_os-prober
-rwxr-xr-x. 1 root root   214 Jul 28  2020 40_custom
-rwxr-xr-x. 1 root root   216 Jul 28  2020 41_custom
-rw-r--r--. 1 root root   483 Jul 28  2020 README
```

{% hint style="success" %}
To full review of grub and grub2 read my LPIC1 book: [https://borosan.gitbook.io/lpic1-exam-guide/1022-install-a-boot-manager#grub](https://borosan.gitbook.io/lpic1-exam-guide/1022-install-a-boot-manager#grub)
{% endhint %}

{% hint style="danger" %}
These step are for demonstration only. Do not repeat them on your production systems. The steps and commands might be different based on your OS. Read Documentations.
{% endhint %}

Securing Grub Configuring users in /etc/grub.d/01\_users:

before:

```
[root@centos7 grub.d]# cat 01_users
#!/bin/sh -e
cat << EOF
if [ -f \${prefix}/user.cfg ]; then
  source \${prefix}/user.cfg
  if [ -n "\${GRUB2_PASSWORD}" ]; then
    set superusers="root"
    export superusers
    password_pbkdf2 root \${GRUB2_PASSWORD}
  fi
fi
EOF
```

after:

```
[root@centos7 grub.d]# cat 01_users
#!/bin/sh -e
cat << EOF
if [ -f \${prefix}/user.cfg ]; then
  source \${prefix}/user.cfg
  if [ -n "\${GRUB2_PASSWORD}" ]; then
    set superusers="root"
    export superusers
    password_pbkdf2 root \${GRUB2_PASSWORD}
  fi
fi
password user1 user1password
password user2 user2password
EOF
```

Copy Configuring **menu entries** from  /boot/grub2/grub.cfg &#x20;

```
menuentry 'CentOS Linux (3.10.0-1160.el7.x86_64) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-3.10.0-1160.el7.x86_64-advanced-21d3b367-651e-420f-b94d-43040b72360a' {
        load_video
        set gfxpayload=keep
        insmod gzio
        insmod part_msdos
        insmod xfs
        set root='hd0,msdos1'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1'  052308ef-1d3c-4cab-a5e5-a5d5c9fc0a2a
        else
          search --no-floppy --fs-uuid --set=root 052308ef-1d3c-4cab-a5e5-a5d5c9fc0a2a
        fi
        linux16 /vmlinuz-3.10.0-1160.el7.x86_64 root=UUID=21d3b367-651e-420f-b94d-43040b72360a ro crashkernel=auto rhgb quiet LANG=en_US.UTF-8
        initrd16 /initramfs-3.10.0-1160.el7.x86_64.img
}

```

and copy them in to **/etc/grub.d/40\_custom** and modify. change `--unrestricted` to  `--users user1,user2` :

```
#!/bin/sh
exec tail -n +3 $0
# This file provides an easy way to add custom menu entries.  Simply type the
# menu entries you want to add after this comment.  Be careful not to change
# the 'exec tail' line above.
menuentry 'CentOS Linux (3.10.0-1160.el7.x86_64) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --users user1,user2 $menuentry_id_option 'gnulinux-3.10.0-1160.el7.x86_64-advanced-21d3b367-651e-420f-b94d-43040b72360a' {
        load_video
        set gfxpayload=keep
        insmod gzio
        insmod part_msdos
        insmod xfs
        set root='hd0,msdos1'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1'  052308ef-1d3c-4cab-a5e5-a5d5c9fc0a2a
        else
          search --no-floppy --fs-uuid --set=root 052308ef-1d3c-4cab-a5e5-a5d5c9fc0a2a
        fi
        linux16 /vmlinuz-3.10.0-1160.el7.x86_64 root=UUID=21d3b367-651e-420f-b94d-43040b72360a ro crashkernel=auto rhgb quiet LANG=en_US.UTF-8
        initrd16 /initramfs-3.10.0-1160.el7.x86_64.img
}

```

Building grub configuration via **grub2-mkconfig -o /boot/grub2/grub.cfg**  command :&#x20;

```
[root@centos7 grub.d]# grub2-mkconfig -o /boot/grub2/grub.cfg
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-3.10.0-1160.el7.x86_64
Found initrd image: /boot/initramfs-3.10.0-1160.el7.x86_64.img
Found linux image: /boot/vmlinuz-0-rescue-251fad2d7b5049ecbb24a0bb534b6986
Found initrd image: /boot/initramfs-0-rescue-251fad2d7b5049ecbb24a0bb534b6986.img
done
```

and done.

.

.

.

resources:

[https://www.gnu.org/software/grub/manual/legacy/Security.html](https://www.gnu.org/software/grub/manual/legacy/Security.html)

[https://access.redhat.com/documentation/en-us/red\_hat\_enterprise\_linux/7/html/security\_guide/sec-using-usbguard](https://access.redhat.com/documentation/en-us/red\_hat\_enterprise\_linux/7/html/security\_guide/sec-using-usbguard)

[https://documentation.suse.com/sles/15-SP1/html/SLES-all/cha-security-policykit.html](https://documentation.suse.com/sles/15-SP1/html/SLES-all/cha-security-policykit.html)

.

