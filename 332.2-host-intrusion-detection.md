# 332.2 Host Intrusion Detection

**Weight:** 5

**Description:** Candidates should be familiar with the use and configuration of common host intrusion detection software. This includes managing the Linux Audit system and verifying a system's integrity.



**Key Knowledge Areas:**

* Use and configure the Linux Audit system
* Use chkrootkit
* Use and configure rkhunter, including updates
* Use Linux Malware Detect
* Automate host scans using cron
* Use RPM and DPKG package management tools to verify the integrity of installed files
* Configure and use AIDE, including rule management
* Awareness of OpenSCAP

**Partial list of the used files, terms and utilities:**

* auditd
* auditctl
* ausearch, aureport
* auditd.conf
* audit.rules
* pam\_tty\_audit.so
* chkrootkit
* rkhunter
* /etc/rkhunter.conf
* maldet
* conf.maldet
* rpm
* dpkg
* aide
* /etc/aide/aide.conf



## Thread Detections Tools

The important thing about threat detection tools is that these are post-incident tools. That means you are alerted once your system has been already compromised!

The tools you need to know about:

* AIDE : standard intrusion detection tool
* OPENScap : RedHat tool for system monitoring&#x20;
* Linux Malware Detect : another tool for detecting malicious software&#x20;
* Rkhunter : hunt rootkits
* Chkrootkit : hunt rootkits

{% hint style="info" %}
For the test it is important to:

* know commands and options
* good understanding of concepts
* Know configuration directives
{% endhint %}

### AIDE

Advanced Intrusion Detection Environment (AIDE) **** is a powerful open source intrusion detection tool that uses predefined rules to check the integrity of files and directories in the Linux operating system. AIDE has its own database to check the integrity of files and directories.

AIDE helps monitor those files that are recently changed or modified. You can keep track of files or directories when someone tries to modify or change them.

{% hint style="warning" %}
&#x20;**Is AIDE secure?**

AIDE is secured by SELinux. SElinux secures the AIDE process with mandatory access control. It defines process types (domains) for each process running on the system. SELinux AIDE policy is very flexible, allowing users to set up their AIDE processes in as secure a method as possible.&#x20;
{% endhint %}

There is a possibility that in some of the Linux distributions, AIDE is not installed. You need to  install it first.

```
[root@rocky8 ~]# dnf list aide
Last metadata expiration check: 2:14:58 ago on Tue 06 Sep 2022 12:59:57 PM +0430.
Installed Packages
aide.x86_64                                                        0.16-14.el8_5.1                                                         @appstream
```

You can check the version of AIDE using `aide -v` .

#### /etc/aide.conf

In AIDE, the path of the configuration file is `/etc/aide.conf`. This configuration can initialize or check the database. In this configuration, some rules are already predefined such as PERMS, NORMAL, LSPP, DATAONLY, and so on. These custom rules contain many defaults related to permissions, inodes, numbers of links, `acl`, `selinux`, etc. One example of a custom rule is :

```shell
$ PERMS= p+i+n+u+g+acl+selinux
```

&#x20;Where:

* `p`: permission
* `i` : inode
* `N` : number of links
* `g` : group
* `acl` : access control list
* `selinux` : SELinux security context

These rules help in tracking and detecting files. If you put PERMS rules on any directory or files, then all these rules are implemented for tracking and monitoring. Using all these declared rules, you can also create your custom rules, which are a combination of multiple rules.

Before initializing the AIDE database, it is important to set rules for directories or files. You can do this in the `/etc/aide.conf` file itself. Suppose you want to keep track of the `/etc/passwd` file so that you can put rules like PERMS on that file to check the integrity of the file using an AIDE database.

```
[root@rocky8 ~]# cat /etc/aide.conf
# Example configuration file for AIDE.

@@define DBDIR /var/lib/aide
@@define LOGDIR /var/log/aide

# The location of the database to be read.
database=file:@@{DBDIR}/aide.db.gz

# The location of the database to be written.
#database_out=sql:host:port:database:login_name:passwd:table
#database_out=file:aide.db.new
database_out=file:@@{DBDIR}/aide.db.new.gz

# Whether to gzip the output to database
gzip_dbout=yes

# Default.
verbose=5

report_url=file:@@{LOGDIR}/aide.log
report_url=stdout
#report_url=stderr
#NOT IMPLEMENTED report_url=mailto:root@foo.com
#NOT IMPLEMENTED report_url=syslog:LOG_AUTH

# These are the default rules.
#
#p:      permissions
#i:      inode:
#n:      number of links
#u:      user
#g:      group
#s:      size
#b:      block count
#m:      mtime
#a:      atime
#c:      ctime
#S:      check for growing size
#acl:           Access Control Lists
#selinux        SELinux security context
#xattrs:        Extended file attributes
#md5:    md5 checksum
#sha1:   sha1 checksum
#sha256:        sha256 checksum
#sha512:        sha512 checksum
#rmd160: rmd160 checksum
#tiger:  tiger checksum

#haval:  haval checksum (MHASH only)
#gost:   gost checksum (MHASH only)
#crc32:  crc32 checksum (MHASH only)
#whirlpool:     whirlpool checksum (MHASH only)

#R:             p+i+n+u+g+s+m+c+acl+selinux+xattrs+md5
#L:             p+i+n+u+g+acl+selinux+xattrs
#E:             Empty group
#>:             Growing logfile p+u+g+i+n+S+acl+selinux+xattrs

# You can create custom rules like this.
# With MHASH...
# ALLXTRAHASHES = sha1+rmd160+sha256+sha512+whirlpool+tiger+haval+gost+crc32
ALLXTRAHASHES = sha1+rmd160+sha256+sha512+tiger
# Everything but access time (Ie. all changes)
EVERYTHING = R+ALLXTRAHASHES

# Sane
# NORMAL = R+sha512
NORMAL = p+i+n+u+g+s+m+c+acl+selinux+xattrs+sha512

# For directories, don't bother doing hashes
DIR = p+i+n+u+g+acl+selinux+xattrs

# Access control only
PERMS = p+u+g+acl+selinux+xattrs

# Logfile are special, in that they often change
LOG = p+u+g+n+S+acl+selinux+xattrs

# Content + file type.
CONTENT = sha512+ftype

# Extended content + file type + access.
CONTENT_EX = sha512+ftype+p+u+g+n+acl+selinux+xattrs

# Some files get updated automatically, so the inode/ctime/mtime change
# but we want to know when the data inside them changes
DATAONLY =  p+n+u+g+s+acl+selinux+xattrs+sha512

# Next decide what directories/files you want in the database.

/boot       CONTENT_EX
/opt        CONTENT

# Admins dot files constantly change, just check perms
/root/\..* PERMS
# Otherwise get all of /root.
/root   CONTENT_EX

# These are too volatile
!/usr/src
!/usr/tmp

# Otherwise get all of /usr.
/usr    CONTENT_EX

# trusted databases
/etc/hosts$      CONTENT_EX
/etc/host.conf$  CONTENT_EX
/etc/hostname$   CONTENT_EX
/etc/issue$      CONTENT_EX
/etc/issue.net$  CONTENT_EX
/etc/protocols$  CONTENT_EX
/etc/services$   CONTENT_EX
/etc/localtime$  CONTENT_EX
/etc/alternatives CONTENT_EX
/etc/sysconfig   CONTENT_EX
/etc/mime.types$ CONTENT_EX
/etc/terminfo    CONTENT_EX
/etc/exports$    CONTENT_EX
/etc/fstab$      CONTENT_EX
/etc/passwd$     CONTENT_EX
/etc/group$      CONTENT_EX
/etc/gshadow$    CONTENT_EX
/etc/shadow$     CONTENT_EX
/etc/subgid$     CONTENT_EX
/etc/subuid$     CONTENT_EX
/etc/security/opasswd$ CONTENT_EX
/etc/skel        CONTENT_EX
/etc/subuid$     CONTENT_EX
/etc/subgid$     CONTENT_EX
/etc/sssd        CONTENT_EX
/etc/machine-id$ CONTENT_EX
/etc/swid        CONTENT_EX
/etc/system-release-cpe$ CONTENT_EX
/etc/shells$     CONTENT_EX
/etc/tmux.conf$  CONTENT_EX
/etc/xattr.conf$ CONTENT_EX


# networking
/etc/hosts.allow$   CONTENT_EX
/etc/hosts.deny$    CONTENT_EX
/etc/firewalld      CONTENT_EX
!/etc/NetworkManager/system-connections
/etc/NetworkManager CONTENT_EX
/etc/networks$ CONTENT_EX
/etc/dhcp CONTENT_EX
/etc/wpa_supplicant CONTENT_EX
/etc/resolv.conf$ DATAONLY
/etc/nscd.conf$ CONTENT_EX

# logins and accounts
/etc/login.defs$ CONTENT_EX
/etc/libuser.conf$ CONTENT_EX
/var/log/faillog$ PERMS
/var/log/lastlog$ PERMS
/var/run/faillock PERMS
/etc/pam.d CONTENT_EX
/etc/security CONTENT_EX
/etc/securetty$ CONTENT_EX
/etc/polkit-1 CONTENT_EX
/etc/sudo.conf$ CONTENT_EX
/etc/sudoers$ CONTENT_EX
/etc/sudoers.d CONTENT_EX

# Shell/X startup files
/etc/profile$ CONTENT_EX
/etc/profile.d CONTENT_EX
/etc/bashrc$ CONTENT_EX
/etc/bash_completion.d CONTENT_EX
/etc/zprofile$ CONTENT_EX
/etc/zshrc$ CONTENT_EX
/etc/zlogin$ CONTENT_EX
/etc/zlogout$ CONTENT_EX
/etc/X11 CONTENT_EX

# Pkg manager
/etc/dnf CONTENT_EX
/etc/yum.conf$ CONTENT_EX
/etc/yum CONTENT_EX
/etc/yum.repos.d CONTENT_EX

# This gets new/removes-old filenames daily
!/var/log/sa
# As we are checking it, we've truncated yesterdays size to zero.
!/var/log/aide.log

# auditing
# AIDE produces an audit record, so this becomes perpetual motion.
/var/log/audit PERMS
/etc/audit CONTENT_EX
/etc/libaudit.conf$ CONTENT_EX
/etc/aide.conf$  CONTENT_EX

# System logs
/etc/rsyslog.conf$ CONTENT_EX
/etc/rsyslog.d CONTENT_EX
/etc/logrotate.conf$ CONTENT_EX
/etc/logrotate.d CONTENT_EX
/etc/systemd/journald.conf$ CONTENT_EX
/var/log LOG+ANF+ARF
/var/run/utmp LOG

# secrets
/etc/pkcs11 CONTENT_EX
/etc/pki CONTENT_EX
/etc/crypto-policies CONTENT_EX
/etc/certmonger CONTENT_EX
/var/lib/systemd/random-seed$ PERMS

# init system
/etc/systemd CONTENT_EX
/etc/rc.d CONTENT_EX
/etc/tmpfiles.d CONTENT_EX

# boot config
/etc/default CONTENT_EX
/etc/grub.d CONTENT_EX
/etc/dracut.conf$ CONTENT_EX
/etc/dracut.conf.d CONTENT_EX

# glibc linker
/etc/ld.so.cache$ CONTENT_EX
/etc/ld.so.conf$ CONTENT_EX
/etc/ld.so.conf.d CONTENT_EX
/etc/ld.so.preload$ CONTENT_EX

# kernel config
/etc/sysctl.conf$ CONTENT_EX
/etc/sysctl.d CONTENT_EX
/etc/modprobe.d CONTENT_EX
/etc/modules-load.d CONTENT_EX
/etc/depmod.d CONTENT_EX
/etc/udev CONTENT_EX
/etc/crypttab$ CONTENT_EX

#### Daemons ####

# cron jobs
/var/spool/at CONTENT
/etc/at.allow$ CONTENT
/etc/at.deny$ CONTENT
/var/spool/anacron CONTENT
/etc/anacrontab$ CONTENT_EX
/etc/cron.allow$ CONTENT_EX
/etc/cron.deny$ CONTENT_EX
/etc/cron.d CONTENT_EX
/etc/cron.daily CONTENT_EX
/etc/cron.hourly CONTENT_EX
/etc/cron.monthly CONTENT_EX
/etc/cron.weekly CONTENT_EX
/etc/crontab$ CONTENT_EX
/var/spool/cron/root CONTENT

# time keeping
/etc/chrony.conf$ CONTENT_EX
/etc/chrony.keys$ CONTENT_EX

# mail
/etc/aliases$ CONTENT_EX
/etc/aliases.db$ CONTENT_EX
/etc/postfix CONTENT_EX

# ssh
/etc/ssh/sshd_config$ CONTENT_EX
/etc/ssh/ssh_config$ CONTENT_EX

# stunnel
/etc/stunnel CONTENT_EX

# printing
/etc/cups CONTENT_EX
/etc/cupshelpers CONTENT_EX
/etc/avahi CONTENT_EX

# web server
/etc/httpd CONTENT_EX

# dns
/etc/named CONTENT_EX
/etc/named.conf$ CONTENT_EX
/etc/named.iscdlv.key$ CONTENT_EX
/etc/named.rfc1912.zones$ CONTENT_EX
/etc/named.root.key$ CONTENT_EX

# xinetd
/etc/xinetd.conf$ CONTENT_EX
/etc/xinetd.d CONTENT_EX

# IPsec
/etc/ipsec.conf$ CONTENT_EX
/etc/ipsec.secrets$ CONTENT_EX
/etc/ipsec.d CONTENT_EX

# USB guard
/etc/usbguard CONTENT_EX

# Ignore some files
!/etc/mtab$
!/etc/.*~

# Now everything else
/etc    PERMS


# With AIDE's default verbosity level of 5, these would give lots of
# warnings upon tree traversal. It might change with future version.
#
#=/lost\+found    DIR
#=/home           DIR

# Ditto /var/log/sa reason...
!/var/log/and-httpd

# Admins dot files constantly change, just check perms
/root/\..* PERMS
!/root/.xauth*
```

#### AIDE Implementation

To implement AIDE on your system, you need to initialize the database. Using this AIDE database, an integrity check is run on all the files and directories. The AIDE database generates in the `/var/lib/aide` directory. You can also check the context of this directory using:

```
[root@rocky8 ~]# ls -ldZ /var/lib/aide/
drwx------. 2 root root system_u:object_r:aide_db_t:s0 6 Feb  7  2022 /var/lib/aide/
```

This directory has `aide_db_t` context set by SELinux. This context is used when you want to treat the files as AIDE database content. AIDE logs are stored in the `/var/log/aide` directory and this directory also has `aide_log_t` context.

To initialize the AIDE database, use the command:&#x20;

```
[root@rocky8 ~]# aide --init
Start timestamp: 2022-09-06 15:25:02 +0430 (AIDE 0.16)
AIDE initialized database at /var/lib/aide/aide.db.new.gz

Number of entries:      67148

---------------------------------------------------
The attributes of the (uncompressed) database(s):
---------------------------------------------------

/var/lib/aide/aide.db.new.gz
  MD5      : 1fl/sBELtndf8QB+Xuknhg==
  SHA1     : OwRxBQJ9qEKdSfJYDArctSEdJHE=
  RMD160   : UqQ/lmJnzI/4N9E4nLdmKfLAZSY=
  TIGER    : 3iuoOi7/glXRftRvCDwkUAyI0bWbgtR7
  SHA256   : MO85PYXGsCu3VKUxuQrWuz9OMbreFJU3
             vWxU9+1jgg8=
  SHA512   : VqY5kWhkJLn45m1ea9d1Gb0jHdg7MNGj
             EbQMjgEGmjWtvfZfh8pZ/8SUQh2EJO+h
             elycT7cD/8hH2lLrT54MUw==


End timestamp: 2022-09-06 15:27:37 +0430 (run time: 2m 35s)
```

This command generates a gzipped file of the database. You can use the zipped file for integrity checking purposes.\
Suppose you need to monitor the `/etc/hosts` file. So that if someone tries to enter a file or tries to modify it in your absence, then you can check that file using AIDE.&#x20;

After installing AIDE on your system, make an entry in the `/etc/aide.conf` file with customized rules. You need to monitor files for changes in permissions, groups, ownership, and file access time. You can then select any customized rules that contain all these points.

Here I put the FIPSR ruleset because these custom rules contain the maximum normal rules.

```shell
FIPSR= p+i+n+u+g+s+m+c+acl+selinux+xattrs+sha256
```

{% hint style="danger" %}
**NOTE**: Before writing anything to the `aide.conf` file, always make a backup.&#x20;

```shell
# cp /etc/aide.conf /etc/aide`date +%F`.conf
```
{% endhint %}

In the `/etc/aide.conf` file, you can write filename with this custom rule:

```shell
/etc/hosts       FIPSR
```

After this, you can initialize the database using the `aide --init` command. This generates a _gzip_ file with the name of `aide.db.new.gz`. Move this file inside the default directory of the AIDE database with the name of `aide.db.gz`

```shell
$ mv aide.db.new.gz  /var/lib/aide/aide.db.gz
```

&#x20;In this way, you can set the database in the proper location.&#x20;

After AIDE is made aware of the current file system status, it can detect file system changes by comparing against the known status. To verify the integrity, use:

```shell
$ aide --check
```

This command gives you output in detail. If the `/etc/hosts` file is modified, then it clearly prompts you with the last modified file.&#x20;

If you want to update the AIDE database after doing new entries in `aide.conf` , use:

```shell
$ aide --update
```

{% hint style="info" %}
**What is SCAP?**

SCAP stands for Security Context Automation Protocol. And that is a community project started by Redhat.

****
{% endhint %}

### OpenSCAP

**OpenSCAP** is an auditing tool that utilizes the Extensible Configuration Checklist Description Format (XCCDF). XCCDF is a standard way of expressing checklist content and defines security checklists. It also combines with other specifications such as CPE, CCE, and OVAL, to create a SCAP-expressed checklist that can be processed by SCAP-validated products.

#### **OpenSCAP Features:**

#### **1. Security Compliance**

In order to minimize the threat of an attack on computer infrastructure, or even completely prevent it, many institutions in both the private and public sectors have adopted the concept of enforcing a **security policy** or a **security benchmark**. These policies define security requirements which all systems used by the institution must meet. It applies not only to systems physically located within the organizations, but often to any third party environments have access to the organizations’ computer infrastructures. In some cases, these policies are defined by government regulations, but many businesses adopt their own security policies even if they are not specifically required to do so by law.

**2. Vulnerability Assessment**

Any organization wishing to protect itself against these attacks must set up a proper and sustainable vulnerability management policy. A good policy satisfies multiple key concepts, which include:

* **Detailed knowledge** of the underlying computer infrastructure
* **Continuous delivery** of **certified** information about currently known security flaws and their **impact**
* **Quick identification of the current security status** of each system (**security analysis**)
* **Prompt reaction** — capability to instantly perform corrective operations where necessary (**remedial action**)
* Possibility to perform security analysis in **automated**,**unattended** way on **regular** basis, regardless of the infrastructure’s complexity
* **Availability** of proper software tools to carry out these tasks with **minimal effort** while preventing or at least minimizing **outage periods**

{% hint style="info" %}
Be aware of what it is! that is enough for LPIC3 exam.
{% endhint %}

### maldet

Linux Malware Detect (LMD) is a malware scanner for Linux released under the GNU GPLv2 license, that is designed around the threats faced in shared hosted environments. It uses threat data from network edge intrusion detection systems to extract malware that is actively being used in attacks and generates signatures for detection. In addition, threat data is also derived from user submissions with the LMD checkout feature and from malware community resources.

#### Installing LMD

**LMD** is not available from online repositories but is distributed as a tarball from the project’s web site. The tarball containing the source code of the latest version is always available as a link, where it can be downloaded with wget command:

```
[root@rocky8 ~]# wget http://www.rfxn.com/downloads/maldetect-current.tar.gz
[root@rocky8 ~]# tar -xvf maldetect-current.tar.gz
.
.

[root@rocky8 ~]# ls -l | grep maldetect
drwxr-xr-x. 3 root root     190 Jun 20  2019 maldetect-1.6.4
-rw-r--r--. 1 root root 1549126 Jul  6  2019 maldetect-current.tar.gz

```

## System Auditing with Auditd



.

.

.

resources:

[https://www.redhat.com/sysadmin/linux-security-aide](https://www.redhat.com/sysadmin/linux-security-aide)

[https://www.teimouri.net/what-is-openscap/#:\~:text=OpenSCAP%20is%20an%20auditing%20tool,content%20and%20defines%20security%20checklists.](https://www.teimouri.net/what-is-openscap/)

.

